<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>美少女</title>
    <!-- 使用兼容的版本组合 -->
  <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
  <script src="https://unpkg.com/@ar-js-org/ar.js@3.4.3/aframe/build/aframe-ar.js"></script>
  <style>
    #camera-permission-message {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.8);
      color: white;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      padding: 20px;
      box-sizing: border-box;
    }
    #start-ar-button {
      background-color: #4CAF50;
      border: none;
      color: white;
      padding: 15px 32px;
      text-align: center;
      text-decoration: none;
      display: inline-block;
      font-size: 16px;
      margin: 20px 0;
      cursor: pointer;
      border-radius: 5px;
    }
    #error-message {
      display: none;
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background-color: rgba(244, 67, 54, 0.9);
      color: white;
      padding: 12px 20px;
      border-radius: 5px;
      z-index: 1001;
      max-width: 70%;
      text-align: center;
      font-size: 14px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
      transition: opacity 0.3s ease;
    }
    #error-message .close-btn {
      position: absolute;
      top: 5px;
      right: 10px;
      background: none;
      border: none;
      color: white;
      font-size: 18px;
      cursor: pointer;
      padding: 0;
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      line-height: 1;
    }
    #model-container {
      visibility: hidden;
    }
    #model-container.visible {
      visibility: visible;
    }
    #status-indicator {
      display: none;
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background-color: rgba(76, 175, 80, 0.9);
      color: white;
      padding: 12px 20px;
      border-radius: 5px;
      z-index: 1000;
      max-width: 70%;
      text-align: center;
      font-size: 14px;
    }
    
    #loading-indicator {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background-color: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 20px;
      border-radius: 5px;
      z-index: 1002;
    }
    
    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top: 4px solid white;
      animation: spin 1s linear infinite;
      margin: 0 auto;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    a-scene {
      display: none;
    }
    
    #model-container {
      opacity: 0;
      transition: opacity 0.3s ease-in-out;
    }
    
    #model-container.visible {
      opacity: 1;
    }
  </style>
</head>
<body>
  <div id="camera-permission-message">
    <h1>增强现实体验</h1>
    <p>请点击下方按钮授权访问摄像头以查看AR效果。将摄像头对准标记图案，即可看到3D模型。</p>
    <button id="start-ar-button">开始AR体验</button>
  </div>
  
  <div id="error-message">
    <p>无法访问摄像头。请确保已授予浏览器摄像头权限，并刷新页面重试。</p>
  </div>
  
  <!-- 状态指示器 -->
  <div id="status-indicator">
    <p>准备就绪，请将摄像头对准标记图案</p>
  </div>
  
  <!-- 加载指示器 -->
  <div id="loading-indicator">
    <div class="spinner"></div>
    <p>正在初始化AR体验...</p>
  </div>
  
  <!-- 简化AR.js配置，避免潜在的兼容性问题 -->
  <a-scene arjs="debugUIEnabled: false" embedded>
    <!-- 添加光源以提高模型可见度 -->
    <a-light type="ambient" color="#ffffff" intensity="0.8"></a-light>
    <a-light type="directional" color="#ffffff" intensity="0.5" position="1 1 1"></a-light>
    
    <!-- 标记相机配置 - 优化的AR.js标记配置 -->
    <a-marker-camera 
      preset="pattern" 
      type="pattern" 
      url="assets/patterns/pattern.patt"
      smooth="true"
      smoothCount="5"
      smoothTolerance="0.1"
      smoothThreshold="2">
      <!-- 3D模型直接放在标记相机内部，这是AR.js中最可靠的做法 -->
      <a-entity id="model-container"
        animation="property: rotation; to: 0 360 0; loop: true; dur:5000">
        <!-- 3D模型实体 - 调整位置和大小以确保可见性 -->
        <a-entity gltf-model="./assets/models/caroon-gltf/scene.gltf" position="0 0.5 0" scale="1 1 1"></a-entity>
      </a-entity>
    </a-marker-camera>
  </a-scene>
  
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const startButton = document.getElementById('start-ar-button');
      const permissionMessage = document.getElementById('camera-permission-message');
      const errorMessage = document.getElementById('error-message');
      const statusIndicator = document.getElementById('status-indicator');
      const loadingIndicator = document.getElementById('loading-indicator');
      const scene = document.querySelector('a-scene');
      
      // 避免页面加载时自动显示错误消息
      errorMessage.style.display = 'none';
      statusIndicator.style.display = 'none';
      loadingIndicator.style.display = 'none';
      
      startButton.addEventListener('click', async function() {
        try {
          // 显示加载指示器
          loadingIndicator.style.display = 'block';
          errorMessage.style.display = 'none';
          
          log('尝试获取摄像头权限...');
          
          // 尝试使用更宽松的摄像头约束，避免设备兼容性问题
          const stream = await navigator.mediaDevices.getUserMedia({
            video: true
          });
          
          log('成功获取摄像头权限，流中包含 ' + stream.getTracks().length + ' 个轨道');
          
          // 立即停止临时流
          stream.getTracks().forEach(track => {
            log('停止临时轨道: ' + track.kind + ', ' + track.label);
            track.stop();
          });
          
          // 隐藏权限消息和加载指示器，显示AR场景和状态提示
          permissionMessage.style.display = 'none';
          loadingIndicator.style.display = 'none';
          scene.style.display = 'block';
          statusIndicator.style.display = 'block';
          
          // 场景已准备就绪，无需额外的reload操作
          log('AR场景已准备就绪，可以开始使用了...');
          
        } catch (err) {
          log('摄像头访问错误: ' + err.name + ': ' + err.message);
          
          // 隐藏加载指示器
          loadingIndicator.style.display = 'none';
          
          // 根据错误类型提供更具体的提示
          let errorText = '';
          if (err.name === 'NotAllowedError') {
            errorText = '您拒绝了摄像头访问权限。请在浏览器设置中允许摄像头访问，然后点击下方按钮重试。';
          } else if (err.name === 'NotFoundError') {
            errorText = '未找到可用的摄像头设备。请确保您的设备有摄像头，并且驱动程序已正确安装。';
          } else if (err.name === 'NotReadableError') {
            errorText = '摄像头被其他应用程序占用。请关闭可能正在使用摄像头的其他程序，然后点击下方按钮重试。';
          } else {
            errorText = '无法访问摄像头: ' + err.message + '，请点击下方按钮重试。';
          }
          
          errorMessage.querySelector('p').textContent = errorText;
          errorMessage.style.display = 'block';
        }
      });
    
    // 辅助函数：显示日志
    function log(message) {
      console.log('[AR体验] ' + message);
      // 在实际应用中，您可以添加UI元素来显示这些日志
    }
      
      // 添加错误消息关闭按钮
      const closeButton = document.createElement('button');
      closeButton.className = 'close-btn';
      closeButton.textContent = '×';
      closeButton.onclick = function() {
        errorMessage.style.display = 'none';
      };
      errorMessage.appendChild(closeButton);
      
      // 优化的AR.js错误事件监听 - 减少自动显示错误消息
      scene.addEventListener('error', function(event) {
        console.error('AR.js错误:', event.detail);
        // 只记录错误，不自动显示错误消息，避免干扰用户体验
      });
      
      // 监听场景加载完成事件
      scene.addEventListener('loaded', function() {
        console.log('AR场景加载完成');
      });
      
      // 监听相机访问错误
      navigator.mediaDevices.addEventListener('devicechange', function() {
        console.log('摄像头设备状态变更');
      });
      
      // 监听标记识别事件 - 简化逻辑，因为模型现在在标记相机内部
      const markerCamera = document.querySelector('a-marker-camera');
      
      markerCamera.addEventListener('markerFound', function() {
        log('标记已识别，AR.js将自动显示模型');
        statusIndicator.querySelector('p').textContent = '已识别到标记，正在显示模型';
      });
      
      markerCamera.addEventListener('markerLost', function() {
        log('标记已丢失，AR.js将自动隐藏模型');
        statusIndicator.querySelector('p').textContent = '请将摄像头对准标记图案';
      });
      
      // 添加模型加载完成事件监听并输出详细信息
      const modelEntity = document.querySelector('[gltf-model]');
      modelEntity.addEventListener('model-loaded', function() {
        log('3D模型加载完成');
        console.log('模型加载完成，ID:', modelEntity.id);
        console.log('模型位置:', modelEntity.getAttribute('position'));
        console.log('模型缩放:', modelEntity.getAttribute('scale'));
      });
      
      // 添加模型错误事件监听
      modelEntity.addEventListener('model-error', function(e) {
        log('模型加载错误: ' + e.detail);
        console.error('模型加载错误详情:', e);
      });
      
      // 提供重试按钮在错误消息中（替代刷新页面）
      const retryButton = document.createElement('button');
      retryButton.textContent = '重试';
      retryButton.style.marginTop = '10px';
      retryButton.style.backgroundColor = '#008CBA';
      retryButton.style.border = 'none';
      retryButton.style.color = 'white';
      retryButton.style.padding = '10px 20px';
      retryButton.style.borderRadius = '5px';
      retryButton.style.cursor = 'pointer';
      retryButton.onclick = function() {
        errorMessage.style.display = 'none';
        // 直接触发开始按钮的点击事件
        startButton.click();
      };
      errorMessage.appendChild(retryButton);
    });
  </script>
</body>
</html>